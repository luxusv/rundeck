{% set providerBase = "/rundeck/storage/provider" %}
{% set converterBase = "/rundeck/storage/converter" %}
{% set configConverterBase = "/rundeck/config/storage/converter" %}


{%- macro storage_provider(provider) %}
    {%- set index = provider | base %}
    {%- set type = getv(printf("%s/type", provider), "db") %}
{% if type == 'db' || type == 'file' %}
rundeck.storage.provider.{{index}}.type={% set type = printf("%s/type", provider) %}{{ getv(type, "db")}}
rundeck.storage.provider.{{index}}.path={% set path = printf("%s/path", provider) %}{{ getv(path, "keys")}}
rundeck.storage.provider.{{index}}.removePathPrefix={% set removepathprefix = printf("%s/removepathprefix", provider) %}{{ getv(removepathprefix, "false")}}
{% elif type == 'vault-storage' %}
    {%- set authBackend = getv(printf("%s/config/authbackend", provider), "token") %}

rundeck.storage.provider.{{index}}.type={% set type = printf("%s/type", provider) %}{{ getv(type, "db")}}
rundeck.storage.provider.{{index}}.path={% set path = printf("%s/path", provider) %}{{ getv(path, "keys")}}
rundeck.storage.provider.{{index}}.removePathPrefix={% set removepathprefix = printf("%s/removepathprefix", provider) %}{{ getv(removepathprefix, "false")}}

rundeck.storage.provider.{{index}}.config.prefix={% set prefix = printf("%s/config/prefix", provider) %}{{ getv(prefix, "")}}
rundeck.storage.provider.{{index}}.config.address={% set address = printf("%s/config/address", provider) %}{{ getv(address, "")}}
rundeck.storage.provider.{{index}}.config.storageBehaviour={% set storagebehaviour = printf("%s/config/storagebehaviour", provider) %}{{ getv(storagebehaviour, "rundeck")}}
rundeck.storage.provider.{{index}}.config.secretBackend={% set secretbackend = printf("%s/config/secretbackend", provider) %}{{ getv(secretbackend, "secret")}}

rundeck.storage.provider.{{index}}.config.authBackend={% set authbackend = printf("%s/config/authbackend", provider) %}{{ getv(authbackend, "token")}}
{% if authBackend == 'token' %}
rundeck.storage.provider.{{index}}.config.token={% set token = printf("%s/config/token", provider) %}{{ getv(token, "")}}
{% elif authBackend == 'approle' %}
rundeck.storage.provider.{{index}}.config.approleId={% set approleid = printf("%s/config/approleid", provider) %}{{ getv(approleid, "")}}
rundeck.storage.provider.{{index}}.config.approleSecretId={% set approlesecretid = printf("%s/config/approlesecretid", provider) %}{{ getv(approlesecretid, "")}}
rundeck.storage.provider.{{index}}.config.approleAuthMount={% set approleauthmount = printf("%s/config/approleauthmount", provider) %}{{ getv(approleauthmount, "")}}
{% elif authBackend == 'cert' %}
rundeck.storage.provider.{{index}}.config.keyStoreFile={% set keystorefile = printf("%s/config/keystorefile", provider) %}{{ getv(keystorefile, "")}}
rundeck.storage.provider.{{index}}.config.keyStoreFilePassword={% set keystorefilepassword = printf("%s/config/keystorefilepassword", provider) %}{{ getv(keystorefilepassword, "")}}
rundeck.storage.provider.{{index}}.config.trustStoreFile={% set truststorefile = printf("%s/config/truststorefile", provider) %}{{ getv(truststorefile, "")}}
rundeck.storage.provider.{{index}}.config.pemFile={% set pemfile = printf("%s/config/pemfile", provider) %}{{ getv(pemfile, "")}}
rundeck.storage.provider.{{index}}.config.clientPemFile={% set clientpemfile = printf("%s/config/clientpemfile", provider) %}{{ getv(clientpemfile, "")}}
rundeck.storage.provider.{{index}}.config.clientKeyPemFile={% set clientkeypemfile = printf("%s/config/clientkeypemfile", provider) %}{{ getv(clientkeypemfile, "")}}
{% elif authBackend == 'github' %}
rundeck.storage.provider.{{index}}.config.githubToken={% set githubtoken = printf("%s/config/githubtoken", provider) %}{{ getv(githubtoken, "")}}
{% elif authBackend == 'userpass' %}
rundeck.storage.provider.{{index}}.config.username={% set username = printf("%s/config/username", provider) %}{{ getv(username, "")}}
rundeck.storage.provider.{{index}}.config.password={% set password = printf("%s/config/password", provider) %}{{ getv(password, "")}}
{% endif %}
{% endmacro %}

{%- macro storage_converter(converter) %}
    {%- set index = converter | base %}
rundeck.storage.converter.{{index}}.type={% set type = printf("%s/type", converter) %}{{ getv(type, "jasypt-encryption") }}
rundeck.storage.converter.{{index}}.path={% set path = printf("%s/path", converter) %}{{ getv(path, "keys") }}
rundeck.storage.converter.{{index}}.config.encryptorType={% set encryptortype = printf("%s/config/encryptortype", converter) %}{{ getv(encryptortype, "custom") }}
rundeck.storage.converter.{{index}}.config.password={% set password = printf("%s/config/password", converter) %}{{ getv(password) }}
rundeck.storage.converter.{{index}}.config.algorithm={% set algorithm = printf("%s/config/algorithm", converter) %}{{ getv(algorithm, "PBEWITHSHA256AND128BITAES-CBC-BC") }}
rundeck.storage.converter.{{index}}.config.provider={% set provider = printf("%s/config/provider", converter) %}{{ getv(provider, "BC") }}
{% endmacro %}

{%- macro config_storage_converter(converter) %}
    {%- set index = converter | base %}
rundeck.config.storage.converter.{{index}}.type={% set type = printf("%s/type", converter) %}{{ getv(type, "jasypt-encryption") }}
rundeck.config.storage.converter.{{index}}.path={% set path = printf("%s/path", converter) %}{{ getv(path, "projects") }}
rundeck.config.storage.converter.{{index}}.config.encryptorType={% set encryptortype = printf("%s/config/encryptortype", converter) %}{{ getv(encryptortype, "custom") }}
rundeck.config.storage.converter.{{index}}.config.password={% set password = printf("%s/config/password", converter) %}{{ getv(password) }}
rundeck.config.storage.converter.{{index}}.config.algorithm={% set algorithm = printf("%s/config/algorithm", converter) %}{{ getv(algorithm, "PBEWITHSHA256AND128BITAES-CBC-BC") }}
rundeck.config.storage.converter.{{index}}.config.provider={% set provider = printf("%s/config/provider", converter) %}{{ getv(provider, "BC") }}
{% endmacro %}

{%- if ls(printf("%s/1", providerBase)) | length == 0 %}
rundeck.storage.provider.1.type=db
rundeck.storage.provider.1.path=keys
{% endif %}


{%- for p in lsdir(providerBase) -%}
    {% set provider = printf("%s/%s", providerBase, p) -%}
    {{ storage_provider(provider) }}
{%- endfor %}

{%- for c in lsdir(converterBase) %}
    {% set converter = printf("%s/%s", converterBase, c) -%}
    {{ storage_converter(converter) }}
{%- endfor %}

rundeck.projectsStorageType={{ getv("/rundeck/projectsstoragetype", "db") }}

{% for c in lsdir(configConverterBase) %}
    {% set converter = printf("%s/%s", configConverterBase, c) -%}
    {{ config_storage_converter(converter) }}
{%- endfor %}

